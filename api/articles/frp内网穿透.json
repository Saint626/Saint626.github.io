{"title":"frp内网穿透","slug":"frp内网穿透","date":"2021-03-04T15:46:00.000Z","updated":"2021-03-04T15:46:00.000Z","comments":true,"path":"api/articles/frp内网穿透.json","excerpt":null,"covers":["https://img-blog.csdnimg.cn/20210130155621425.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70#pic_center","https://img-blog.csdnimg.cn/20210130161150757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70","https://img-blog.csdnimg.cn/20210130162532952.png","https://img-blog.csdnimg.cn/20210130162740481.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70","https://img-blog.csdnimg.cn/20210130164038326.png","https://picture.saintblog.top/Linux/centos/frp_ssh.png","https://img-blog.csdnimg.cn/20210130165325342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70#pic_center","https://img-blog.csdnimg.cn/20210130165442897.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70"],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\css\\APlayer.min.css\"><script src=\"\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\js\\Meting.min.js\"></script><h1 id=\"frp的原理\"><a href=\"#frp的原理\" class=\"headerlink\" title=\"frp的原理\"></a>frp的原理</h1><center><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130155621425.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70#pic_center\" alt=\"frp的原理\"  /></center>\n\n<h1 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h1><ol>\n<li>vps一台, 前提是要有公网ip, 这里我是用的是阿里云9.9包邮的学生机</li>\n<li>内网服务器一台, 当然也可以使用虚拟机</li>\n</ol>\n<h1 id=\"配置frp实现ssh连接\"><a href=\"#配置frp实现ssh连接\" class=\"headerlink\" title=\"配置frp实现ssh连接\"></a>配置frp实现ssh连接</h1><h2 id=\"1-服务端配置\"><a href=\"#1-服务端配置\" class=\"headerlink\" title=\"1. 服务端配置\"></a>1. 服务端配置</h2><ol>\n<li><p>查看处理器架构下载对应的frp</p>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@iZigmm8k8711fhZ</span> ~]<span class=\"meta\"># arch</span></span><br><span class=\"line\">x86_64</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>下载</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/fatedier/</span>frp<span class=\"regexp\">/releases/</span>download<span class=\"regexp\">/v0.22.0/</span>frp_0.<span class=\"number\">22.0</span>_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>解压缩</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">tar</span> <span class=\"selector-tag\">-xvzf</span> <span class=\"selector-tag\">frp_0</span><span class=\"selector-class\">.22</span><span class=\"selector-class\">.0_linux_amd64</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\"><span class=\"selector-tag\">mv</span> <span class=\"selector-tag\">frp_0</span><span class=\"selector-class\">.22</span><span class=\"selector-class\">.0_linux_amd64</span> <span class=\"selector-tag\">frp</span></span><br><span class=\"line\"><span class=\"selector-tag\">cd</span> <span class=\"selector-tag\">frp</span></span><br><span class=\"line\"><span class=\"selector-tag\">ls</span> <span class=\"selector-tag\">-l</span></span><br></pre></td></tr></table></figure>\n<p><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130161150757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70\" alt=\"\"></p>\n<p>服务端只需要关注的是文件名中带有<code>frps</code>字样的就好</p>\n<ul>\n<li><code>frps</code>服务端启动文件</li>\n<li><code>frps.ini</code>服务端配置文件</li>\n</ul>\n</li>\n<li><p>修改服务端配置文件</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">vim</span> <span class=\"selector-tag\">frps</span><span class=\"selector-class\">.ini</span></span><br></pre></td></tr></table></figure>\n<p>修改一下内容</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">bind_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_port</span> = <span class=\"number\">7501</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_user</span> = admin</span><br><span class=\"line\"><span class=\"attr\">dashboard_pwd</span> = admin</span><br></pre></td></tr></table></figure>\n<ol>\n<li><code>bind_port</code>表示客户端与服务端连接的端口, 可以修改, 需要跟客户端的<code>bind_port</code>一致</li>\n<li><code>dashboard_port</code>是服务端仪表盘的端口号</li>\n<li><code>token</code>是服务端与客户端之间连接需要的令牌</li>\n<li><code>dashboard_user</code>与<code>dashboard_pwd</code>是登录仪表盘需要的账号密码, 可以自行修改</li>\n</ol>\n</li>\n<li><p>启动服务</p>\n<ol>\n<li><p>直接执行</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">./frps</span> -c frps.ini</span><br></pre></td></tr></table></figure>\n<p><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130162532952.png\" alt=\"\"></p>\n</li>\n<li><p>在后台运行</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nohup ./frps -c frps.ini &gt; ./nohup.<span class=\"keyword\">out</span> <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span> &amp;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>查看仪表盘</p>\n<p>此时可以登录刚刚配置文件中的仪表盘, 在浏览器中输入 <code>公网ip:端口号(xx.xx.xx.xx:7501)</code></p>\n<p><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130162740481.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70\" alt=\"\"></p>\n<p>因为是直接访问阿里云服务器的端口, 所以需要在阿里云上的防火墙添加这个端口, 否则访问会被拒绝</p>\n</li>\n</ol>\n<h2 id=\"2-客户端配置\"><a href=\"#2-客户端配置\" class=\"headerlink\" title=\"2. 客户端配置\"></a>2. 客户端配置</h2><p>需要在内网的服务器或虚拟机上同样安装frp, 安装方式与上面的一致</p>\n<p>但是客户端的配置文件需要文件名含有<code>frpc</code>的文件</p>\n<ul>\n<li><code>frpc</code> 客户端启动程序</li>\n<li><code>frpc.ini</code> 客户端配置文件</li>\n</ul>\n<ol>\n<li><p>配置客户端, 编辑<code>frpc.ini</code>文件</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">server_addr</span> = xx.xx.xx.xx</span><br><span class=\"line\"><span class=\"attr\">server_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[ssh]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = tcp</span><br><span class=\"line\"><span class=\"attr\">local_ip</span> = <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span></span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">remote_port</span> = <span class=\"number\">8001</span></span><br></pre></td></tr></table></figure>\n<ol>\n<li><code>server_addr</code>是公网 ip 地址</li>\n<li><code>server_port</code> 是服务端设置的与 frp 客户端连接的端口号, 需要与服务端的端口号一致, 上面服务端的端口号是 <code>7001</code>, 所以这里也是<code>7001</code></li>\n<li><code>token</code>令牌, 与服务端保持一致</li>\n<li><code>type</code>代理类型, 我们配置的<code>ssh</code>连接, 所以设置为<code>tcp</code></li>\n<li><code>local_ip</code>本地 ip 地址</li>\n<li><code>local_port</code>是内网设置的 ssh 端口</li>\n<li><code>remote_port</code>是提供给外网访问的服务端口, 访问的是<code>8001</code>, 其实访问的是22端口</li>\n</ol>\n</li>\n<li><p>启动客户端</p>\n<ol>\n<li><p>直接执行</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">./frpc</span> -c frpc.ini</span><br></pre></td></tr></table></figure>\n<p><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130164038326.png\" alt=\"\"></p>\n</li>\n<li><p>在后台运行</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nohup ./frpc -c frpc.ini &gt; ./nohup.<span class=\"keyword\">out</span> <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span> &amp;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>通过公网ssh连接客户端</p>\n<p>使用ssh连接命令</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title\">ssh</span> -p remote_<span class=\"keyword\">port</span> username@公网ip地址</span><br></pre></td></tr></table></figure>\n<p><img src= \"/img/loading.gif\" data-src=\"https://picture.saintblog.top/Linux/centos/frp_ssh.png\" alt=\"frp内网穿透ssh连接\"></p>\n</li>\n</ol>\n<h1 id=\"配置frp实现web服务访问\"><a href=\"#配置frp实现web服务访问\" class=\"headerlink\" title=\"配置frp实现web服务访问\"></a>配置frp实现web服务访问</h1><p>既然ssh可以了, web服务当然也要试一试</p>\n<h2 id=\"1-服务端配置-1\"><a href=\"#1-服务端配置-1\" class=\"headerlink\" title=\"1. 服务端配置\"></a>1. 服务端配置</h2><ul>\n<li><p>同样是修改<code>frps.ini</code>文件的内容</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">bind_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_port</span> = <span class=\"number\">7501</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_user</span> = admin</span><br><span class=\"line\"><span class=\"attr\">dashboard_pwd</span> = admin</span><br><span class=\"line\"><span class=\"attr\">vhost_http_port</span> = <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">vhost_https_port</span> = <span class=\"number\">8082</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>vhost_http_port</code>与<code>vhost_https_port</code>用来对服务端主机进行访问的端口, 需要在防火墙开放端口</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-客户端配置-1\"><a href=\"#2-客户端配置-1\" class=\"headerlink\" title=\"2. 客户端配置\"></a>2. 客户端配置</h2><ul>\n<li><p>修改<code>frpc.ini</code>文件的内容</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">server_addr</span> = xx.xx.xx.xx</span><br><span class=\"line\"><span class=\"attr\">server_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[ssh]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = tcp</span><br><span class=\"line\"><span class=\"attr\">local_ip</span> = <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span></span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">remote_port</span> = <span class=\"number\">8001</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[web]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = http</span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">custom_domains</span> = 公网ip或与域名</span><br></pre></td></tr></table></figure>\n<p>服务的启动方式与上面的一致, 可以通过 <code>xx.xx.xx.xx:8081</code>或<code>域名:8081</code>进行访问</p>\n<p>我在9000端口启动了一个tomcat7服务, 可以看到效果</p>\n<center><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130165325342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70#pic_center\" style=\"zoom: 50%;\" ></img></center>\n\n<p>手机端通过移动数据的方式访问同样可以</p>\n</li>\n</ul>\n<p>​    <center><img src= \"/img/loading.gif\" data-src=\"https://img-blog.csdnimg.cn/20210130165442897.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70\" style=\"zoom: 50%;\" /></center></p>\n<h1 id=\"配置frp开机自启动\"><a href=\"#配置frp开机自启动\" class=\"headerlink\" title=\"配置frp开机自启动\"></a>配置frp开机自启动</h1><p>当服务器因为某些不可抗力重启的时候, 使用上面的方式没办法让frp自动启动, 所以这里选择将 frp 服务交给systemctl来管理开机启动的服务.</p>\n<ol>\n<li><p>将<code>frpc</code>执行文件放在<code>/bin/</code>目录下</p>\n<figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mv ./frp /bin/</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<ol>\n<li><p>将<code>frpc.ini</code>配置文件放在<code>/etc/</code>目录下</p>\n<figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mv ./frp.ini /etc/</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>新建<code>frp.service</code>将frp托管给systemctl管理</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># sudo vim /lib/systemd/system/frp.service</span></span><br></pre></td></tr></table></figure>\n<p>如下修改</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=frpc server daemon</span><br><span class=\"line\"><span class=\"attr\">Wants</span> = network-<span class=\"literal\">on</span>line.target</span><br><span class=\"line\"><span class=\"attr\">After</span> = network.target</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>=/bin/frpc -c /etc/frpc.ini</span><br><span class=\"line\"><span class=\"attr\">Type</span>=simple</span><br><span class=\"line\"><span class=\"attr\">StandardOutput</span> = syslog</span><br><span class=\"line\"><span class=\"attr\">StandardError</span> = inherit</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"attr\">Restart</span> = always</span><br><span class=\"line\"><span class=\"attr\">RestartSec</span>=<span class=\"number\">1</span>min</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>\n<ul>\n<li>1, 2 步可省略, 但是<code>ExecStart=/bin/frpc -c /etc/frpc.ini</code>这里的路径要写对</li>\n<li><code>After = network.target</code>在网络准备好后启动</li>\n<li><code>Restart = always</code>重启</li>\n<li><code>RestartSec=1min</code>重启失败会1分钟后再次启动</li>\n</ul>\n<p>添加重启是预防网络还没准备好就启动 frp 了,  这种情况下 frp 必然启动失败, 导致内网穿透失败, 所以加入<code>RestartSec=1min</code>来预防此种情况</p>\n</li>\n<li><p>将<code>frp.service</code>载入<code>systemctl</code></p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sudo systemctl daemon-reload</span></span><br></pre></td></tr></table></figure>\n<ol>\n<li><code>systemctl</code>常用命令(记得加<code>sudo</code>)</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"keyword\">start</span> frp        <span class=\"comment\"># 启动frp服务</span></span><br><span class=\"line\">systemctl restart frp    <span class=\"comment\"># 重启frp服务</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">stop</span> frp        <span class=\"comment\"># 停止frp服务</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">status</span> frp    <span class=\"comment\"># 查看frp服务状态</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">enable</span> frp    <span class=\"comment\"># 设置frp服务开机自启动</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">disable</span> frp    <span class=\"comment\"># 禁止frp服务开机自启动</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n","more":"<h1 id=\"frp的原理\"><a href=\"#frp的原理\" class=\"headerlink\" title=\"frp的原理\"></a>frp的原理</h1><center><img src=\"https://img-blog.csdnimg.cn/20210130155621425.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70#pic_center\" alt=\"frp的原理\"  /></center>\n\n<h1 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h1><ol>\n<li>vps一台, 前提是要有公网ip, 这里我是用的是阿里云9.9包邮的学生机</li>\n<li>内网服务器一台, 当然也可以使用虚拟机</li>\n</ol>\n<h1 id=\"配置frp实现ssh连接\"><a href=\"#配置frp实现ssh连接\" class=\"headerlink\" title=\"配置frp实现ssh连接\"></a>配置frp实现ssh连接</h1><h2 id=\"1-服务端配置\"><a href=\"#1-服务端配置\" class=\"headerlink\" title=\"1. 服务端配置\"></a>1. 服务端配置</h2><ol>\n<li><p>查看处理器架构下载对应的frp</p>\n<figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root<span class=\"symbol\">@iZigmm8k8711fhZ</span> ~]<span class=\"meta\"># arch</span></span><br><span class=\"line\">x86_64</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>下载</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https:<span class=\"regexp\">//gi</span>thub.com<span class=\"regexp\">/fatedier/</span>frp<span class=\"regexp\">/releases/</span>download<span class=\"regexp\">/v0.22.0/</span>frp_0.<span class=\"number\">22.0</span>_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>解压缩</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">tar</span> <span class=\"selector-tag\">-xvzf</span> <span class=\"selector-tag\">frp_0</span><span class=\"selector-class\">.22</span><span class=\"selector-class\">.0_linux_amd64</span><span class=\"selector-class\">.tar</span><span class=\"selector-class\">.gz</span></span><br><span class=\"line\"><span class=\"selector-tag\">mv</span> <span class=\"selector-tag\">frp_0</span><span class=\"selector-class\">.22</span><span class=\"selector-class\">.0_linux_amd64</span> <span class=\"selector-tag\">frp</span></span><br><span class=\"line\"><span class=\"selector-tag\">cd</span> <span class=\"selector-tag\">frp</span></span><br><span class=\"line\"><span class=\"selector-tag\">ls</span> <span class=\"selector-tag\">-l</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://img-blog.csdnimg.cn/20210130161150757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70\" alt=\"\"></p>\n<p>服务端只需要关注的是文件名中带有<code>frps</code>字样的就好</p>\n<ul>\n<li><code>frps</code>服务端启动文件</li>\n<li><code>frps.ini</code>服务端配置文件</li>\n</ul>\n</li>\n<li><p>修改服务端配置文件</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">vim</span> <span class=\"selector-tag\">frps</span><span class=\"selector-class\">.ini</span></span><br></pre></td></tr></table></figure>\n<p>修改一下内容</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">bind_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_port</span> = <span class=\"number\">7501</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_user</span> = admin</span><br><span class=\"line\"><span class=\"attr\">dashboard_pwd</span> = admin</span><br></pre></td></tr></table></figure>\n<ol>\n<li><code>bind_port</code>表示客户端与服务端连接的端口, 可以修改, 需要跟客户端的<code>bind_port</code>一致</li>\n<li><code>dashboard_port</code>是服务端仪表盘的端口号</li>\n<li><code>token</code>是服务端与客户端之间连接需要的令牌</li>\n<li><code>dashboard_user</code>与<code>dashboard_pwd</code>是登录仪表盘需要的账号密码, 可以自行修改</li>\n</ol>\n</li>\n<li><p>启动服务</p>\n<ol>\n<li><p>直接执行</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">./frps</span> -c frps.ini</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://img-blog.csdnimg.cn/20210130162532952.png\" alt=\"\"></p>\n</li>\n<li><p>在后台运行</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nohup ./frps -c frps.ini &gt; ./nohup.<span class=\"keyword\">out</span> <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span> &amp;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>查看仪表盘</p>\n<p>此时可以登录刚刚配置文件中的仪表盘, 在浏览器中输入 <code>公网ip:端口号(xx.xx.xx.xx:7501)</code></p>\n<p><img src=\"https://img-blog.csdnimg.cn/20210130162740481.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70\" alt=\"\"></p>\n<p>因为是直接访问阿里云服务器的端口, 所以需要在阿里云上的防火墙添加这个端口, 否则访问会被拒绝</p>\n</li>\n</ol>\n<h2 id=\"2-客户端配置\"><a href=\"#2-客户端配置\" class=\"headerlink\" title=\"2. 客户端配置\"></a>2. 客户端配置</h2><p>需要在内网的服务器或虚拟机上同样安装frp, 安装方式与上面的一致</p>\n<p>但是客户端的配置文件需要文件名含有<code>frpc</code>的文件</p>\n<ul>\n<li><code>frpc</code> 客户端启动程序</li>\n<li><code>frpc.ini</code> 客户端配置文件</li>\n</ul>\n<ol>\n<li><p>配置客户端, 编辑<code>frpc.ini</code>文件</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">server_addr</span> = xx.xx.xx.xx</span><br><span class=\"line\"><span class=\"attr\">server_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[ssh]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = tcp</span><br><span class=\"line\"><span class=\"attr\">local_ip</span> = <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span></span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">remote_port</span> = <span class=\"number\">8001</span></span><br></pre></td></tr></table></figure>\n<ol>\n<li><code>server_addr</code>是公网 ip 地址</li>\n<li><code>server_port</code> 是服务端设置的与 frp 客户端连接的端口号, 需要与服务端的端口号一致, 上面服务端的端口号是 <code>7001</code>, 所以这里也是<code>7001</code></li>\n<li><code>token</code>令牌, 与服务端保持一致</li>\n<li><code>type</code>代理类型, 我们配置的<code>ssh</code>连接, 所以设置为<code>tcp</code></li>\n<li><code>local_ip</code>本地 ip 地址</li>\n<li><code>local_port</code>是内网设置的 ssh 端口</li>\n<li><code>remote_port</code>是提供给外网访问的服务端口, 访问的是<code>8001</code>, 其实访问的是22端口</li>\n</ol>\n</li>\n<li><p>启动客户端</p>\n<ol>\n<li><p>直接执行</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">./frpc</span> -c frpc.ini</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://img-blog.csdnimg.cn/20210130164038326.png\" alt=\"\"></p>\n</li>\n<li><p>在后台运行</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nohup ./frpc -c frpc.ini &gt; ./nohup.<span class=\"keyword\">out</span> <span class=\"number\">2</span>&gt;&amp;<span class=\"number\">1</span> &amp;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>通过公网ssh连接客户端</p>\n<p>使用ssh连接命令</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title\">ssh</span> -p remote_<span class=\"keyword\">port</span> username@公网ip地址</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://picture.saintblog.top/Linux/centos/frp_ssh.png\" alt=\"frp内网穿透ssh连接\"></p>\n</li>\n</ol>\n<h1 id=\"配置frp实现web服务访问\"><a href=\"#配置frp实现web服务访问\" class=\"headerlink\" title=\"配置frp实现web服务访问\"></a>配置frp实现web服务访问</h1><p>既然ssh可以了, web服务当然也要试一试</p>\n<h2 id=\"1-服务端配置-1\"><a href=\"#1-服务端配置-1\" class=\"headerlink\" title=\"1. 服务端配置\"></a>1. 服务端配置</h2><ul>\n<li><p>同样是修改<code>frps.ini</code>文件的内容</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">bind_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_port</span> = <span class=\"number\">7501</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"><span class=\"attr\">dashboard_user</span> = admin</span><br><span class=\"line\"><span class=\"attr\">dashboard_pwd</span> = admin</span><br><span class=\"line\"><span class=\"attr\">vhost_http_port</span> = <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">vhost_https_port</span> = <span class=\"number\">8082</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>vhost_http_port</code>与<code>vhost_https_port</code>用来对服务端主机进行访问的端口, 需要在防火墙开放端口</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-客户端配置-1\"><a href=\"#2-客户端配置-1\" class=\"headerlink\" title=\"2. 客户端配置\"></a>2. 客户端配置</h2><ul>\n<li><p>修改<code>frpc.ini</code>文件的内容</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[common]</span></span><br><span class=\"line\"><span class=\"attr\">server_addr</span> = xx.xx.xx.xx</span><br><span class=\"line\"><span class=\"attr\">server_port</span> = <span class=\"number\">7001</span></span><br><span class=\"line\"><span class=\"attr\">token</span> = <span class=\"number\">12345678</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[ssh]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = tcp</span><br><span class=\"line\"><span class=\"attr\">local_ip</span> = <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span></span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">remote_port</span> = <span class=\"number\">8001</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[web]</span></span><br><span class=\"line\"><span class=\"attr\">type</span> = http</span><br><span class=\"line\"><span class=\"attr\">local_port</span> = <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"attr\">custom_domains</span> = 公网ip或与域名</span><br></pre></td></tr></table></figure>\n<p>服务的启动方式与上面的一致, 可以通过 <code>xx.xx.xx.xx:8081</code>或<code>域名:8081</code>进行访问</p>\n<p>我在9000端口启动了一个tomcat7服务, 可以看到效果</p>\n<center><img src=\"https://img-blog.csdnimg.cn/20210130165325342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70#pic_center\" style=\"zoom: 50%;\" ></img></center>\n\n<p>手机端通过移动数据的方式访问同样可以</p>\n</li>\n</ul>\n<p>​    <center><img src=\"https://img-blog.csdnimg.cn/20210130165442897.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODIzODA2,size_16,color_FFFFFF,t_70\" style=\"zoom: 50%;\" /></center></p>\n<h1 id=\"配置frp开机自启动\"><a href=\"#配置frp开机自启动\" class=\"headerlink\" title=\"配置frp开机自启动\"></a>配置frp开机自启动</h1><p>当服务器因为某些不可抗力重启的时候, 使用上面的方式没办法让frp自动启动, 所以这里选择将 frp 服务交给systemctl来管理开机启动的服务.</p>\n<ol>\n<li><p>将<code>frpc</code>执行文件放在<code>/bin/</code>目录下</p>\n<figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mv ./frp /bin/</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<ol>\n<li><p>将<code>frpc.ini</code>配置文件放在<code>/etc/</code>目录下</p>\n<figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># mv ./frp.ini /etc/</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>新建<code>frp.service</code>将frp托管给systemctl管理</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># sudo vim /lib/systemd/system/frp.service</span></span><br></pre></td></tr></table></figure>\n<p>如下修改</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=frpc server daemon</span><br><span class=\"line\"><span class=\"attr\">Wants</span> = network-<span class=\"literal\">on</span>line.target</span><br><span class=\"line\"><span class=\"attr\">After</span> = network.target</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>=/bin/frpc -c /etc/frpc.ini</span><br><span class=\"line\"><span class=\"attr\">Type</span>=simple</span><br><span class=\"line\"><span class=\"attr\">StandardOutput</span> = syslog</span><br><span class=\"line\"><span class=\"attr\">StandardError</span> = inherit</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"attr\">Restart</span> = always</span><br><span class=\"line\"><span class=\"attr\">RestartSec</span>=<span class=\"number\">1</span>min</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"section\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>\n<ul>\n<li>1, 2 步可省略, 但是<code>ExecStart=/bin/frpc -c /etc/frpc.ini</code>这里的路径要写对</li>\n<li><code>After = network.target</code>在网络准备好后启动</li>\n<li><code>Restart = always</code>重启</li>\n<li><code>RestartSec=1min</code>重启失败会1分钟后再次启动</li>\n</ul>\n<p>添加重启是预防网络还没准备好就启动 frp 了,  这种情况下 frp 必然启动失败, 导致内网穿透失败, 所以加入<code>RestartSec=1min</code>来预防此种情况</p>\n</li>\n<li><p>将<code>frp.service</code>载入<code>systemctl</code></p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sudo systemctl daemon-reload</span></span><br></pre></td></tr></table></figure>\n<ol>\n<li><code>systemctl</code>常用命令(记得加<code>sudo</code>)</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"keyword\">start</span> frp        <span class=\"comment\"># 启动frp服务</span></span><br><span class=\"line\">systemctl restart frp    <span class=\"comment\"># 重启frp服务</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">stop</span> frp        <span class=\"comment\"># 停止frp服务</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">status</span> frp    <span class=\"comment\"># 查看frp服务状态</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">enable</span> frp    <span class=\"comment\"># 设置frp服务开机自启动</span></span><br><span class=\"line\">systemctl <span class=\"keyword\">disable</span> frp    <span class=\"comment\"># 禁止frp服务开机自启动</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"centos","path":"api/tags/centos.json"}]}